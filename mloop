#!/bin/sh

# mloop - a thin command-line interface to a mail folder using mblaze

# this script goes with mpane, which invokes it in a new tmux window
# it reads from stdin and allows for simple display and reply of
# messages in the folder mpane dumps out above us.

mdopts="$*"

#stty -echo
#trap 'stty echo; exit 0' INT QUIT TERM

tmux_reply () {
	typeset msgno
	msgno=$1
	shift
	tmux new-window -n "[reply $msgno]" "env EDITOR=emax mrep $* ${msgno}; wait_for_me"
}

rescan () {
	typeset nothing afterargs
	nothing=$1
	shift
	afterargs="$*"
	[ -n "${CMD}" ] && {
		if [ ${nothing} = inbox ]; then
			FOLDER=${INBOX_FOLDER-INBOX}
		elif [ -n "${afterargs}" ]; then
			FOLDER=${afterargs}
		fi
		echo ${CMD} ${FOLDER}
		${CMD} ${FOLDER}
	}
}

msgno=
[ -z "${FOLDER}" ] && FOLDER=${INBOX_FOLDER-INBOX}
new=
[ "${CMD}" = "mnewbox" ] && new='*'
echo folder: ${FOLDER}, cmd: ${CMD}
while read nothing?"${FOLDER}${new}> " afterargs; do
	cmd="mdisplay ${mdopts}"
#	echo nothing: ${nothing}, afterargs: ${afterargs}
	case ${nothing} in
		reply)
			cmd=tmux_reply
			case ${afterargs} in
				[0-9]*)
					set -- ${afterargs}
					tmux set-buffer $1
					shift
					afterargs="$*"
					;;
			esac
			;;
		quit|exit)
			exit 0
			;;
		refresh|reload|open|clear|inbox)
			rescan ${nothing} ${afterargs}
			continue
			;;
		all)
			CMD=minbox
			new=
			rescan ${nothing} ${afterargs}
			continue
			;;
		new)
			CMD=mnewbox
			new='*'
			rescan ${nothing} ${afterargs}
			continue
			;;
		spam)
			if [ -n "${afterargs}" ]; then
				echo mrespam ${afterargs}
				mrespam ${afterargs}
				continue
			fi
			cmd=mrespam
			;;
		unspam)
			if [ -n "${afterargs}" ]; then
				echo munspam ${afterargs}
				munspam ${afterargs}
				continue
			fi
			cmd=munspam
			;;
		grep)
			magrep ${afterargs} | mthread | mscan
			continue
			;;
		restrict)
			magrep ${afterargs} | mthread | mseq -S | mscan
			continue
			;;
		dirs)
			mnewdirs
			continue
			;;
		help)
			echo '[#] | reply, quit, refresh, open, inbox, all, new, spam, unspam, grep, restrict, dirs'
			continue
			;;
		[0-9]*) tmux set-buffer ${nothing} ;;
	esac
	msgno=$(tmux show-buffer)
	if [ -n "${msgno}" ]; then
		f=$(mpick ${msgno} 2>/dev/null)
		[ -n $f ] && {
			echo ${cmd} ${msgno} ${afterargs}
			${cmd} ${msgno} ${afterargs}
		}
	fi
done
